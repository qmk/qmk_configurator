Code Structure
==============

Currently this is a very simple Single Page App (SPA) written using jQuery, without any framework like code. SPA hard mode.  Longer term, the project is interested in moving to something more formal, but we know that the current code base is a prototype and is being used to try out different ideas and iterate quickly.

The core of the code is executed from a jQuery ready block. This ensures that the DOM and libraries we use are initialized.

The core data structure is keycode. This contains 3 related sets of data:

 1. the keycodes known to QMK
 1. formatting information for a keycode display
 1. keypress.js bindings used to capture keypresses on the visual layout.

Keycodes are generated by a function to avoid global state. This
can be leveraged later for things like unit testing. All state is
captured in the ready closure, and we only push one function to the
global window object at this time.

The current functions for the configurator are:

 1. Editing of Keymaps
 1. Exporting and Import of Custom Keymaps via JSON
 1. Compiling those keymaps into firmware files. Currently, only .hex files are supported
 1. Downloading Hex Files or Source code generated

Code Style
==========

 - A very conservative eslint.js file is used to ensure certain Javascript standards. Please configure your editor/IDE to output and respect the warnings. If the warnings seem overly broad, we are open to relaxing or changing them if they seem unreasonable.
 - Prettier is our formatter of choice, and we ask you to please use it after making changes. Automatic code formatting reduces the cognitive overhead for different coding styles and allows a group to worry about logic and data structures, instead of personal preferences.
 - you are free to use any ES2016 that is currently supported in stable Firefox or Chrome; check caniuse.com to be sure.  Until we transition to something like babel experimental JS features are probably not a good idea. If you feel strongly and a good polyfill is available we are open to discussion.
 - In general, if a javascript object is an jquery element, we try to use the $prefix notation. e.g. $keyboard to signal to the reader it's a jquery object. Try to avoid using $() where possible. There are still locations in the code that haven't been cleaned up or are dynamic. Where possible we setup a single element reference in the ready block and use that consistently through the code.
 - favor named functions over anonymous where that makes sense. This makes debugging much easier, as chrome will use the named function in the trace vs a randomly generated function name.
 - we currently use the built in jQuery promises and http implementations. In the future we should probably transition to axios and native promises. Try to avoid using jQuery specific iteration unless you doing something with UI elements. The lodash (for objects) or native (arrays and strings) ones are generally superior.

External Dependencies
=====================

 - jQuery for DOM manipulation
 - jQuery UI components for drag and drop.
 - keypress.js for keyboard bindings
 - lodash.js for general collections and utility functions


Startup
=======

The general flow of the code:

 1. setup instance specific variables
 1. create a new keymap object
 1. setup any helper functions
 1. setup routing; simple hash based
 1. generate the keycode UI from keycodes
 1. setup drag and drop
 1. request keyboard list from API
 1. setup event handlers
 1. setup key input handler
 1. run check status polling loop

Major UI Elements
=================

### Keycode Display

TBD

### Status Panel

TBD

### VisualKeymap

TBD

### Buttons

TBD


Editing of Keymaps
==================

User Keymap data is stored in the Keymap data structure. It used to be a global array of values, but this made change detection a challange and lots of code would set values directly into the datastructure. These are now refactored into an API. The Keymap is also responsible for exporting the keymap to JSON. Future work, we should probably move importing and parsing into here too.

We support 3 styles of input to the visual keymap.

 1. dragging a keycode to the keymap. This includes swapping keycodes on the keymap. (jQuery draggable)
 1. clicking on the keymap and then clicking on a keycode. (keypress.js)
 1. clicking on the keymap and then pressing a key on your keyboard interactively (click handler)


Exporting and Import of Custom Keymaps via JSON
===============================================

Importing of keymaps can be driven by multiple event

 - an event from the layout drop down
 - an event from switching keyboards
 - importing a new keymap from a JSON file

Compiling those keymaps into Hex files
======================================

All compilation of keymaps is done via the API. When you are ready to compile a keymap, press the compile button and this will send an RESTful POST request to the API containing the JSON for your keymap. On success we enable download buttons for the source and hex files. Compilation is asynchronous and we poll on a 500ms interval for changes on the API baesd on the handle returned by the API.


Downloading Hex Files or Source code generated
==============================================

If a keymap is successfully compiled, the backend returns a HTTP location which we use when you click download hex.
